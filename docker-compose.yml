version: '3.8'

services:
  # PostgreSQL Database
  db:
    image: postgres:15
    container_name: instagram_tracker_db
    restart: unless-stopped
    environment:
      - POSTGRES_USER=user
      - POSTGRES_PASSWORD=passd
      - POSTGRES_DB=reels
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - instagram_tracker_network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U user -d reels"]
      interval: 10s
      timeout: 5s
      retries: 5

  # Ð˜Ð½Ð¸Ñ†Ð¸Ð°Ð»Ð¸Ð·Ð°Ñ†Ð¸Ñ Ð‘Ð” (Ð¼Ð¸Ð³Ñ€Ð°Ñ†Ð¸Ð¸ + Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ñ‹)
  init:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: instagram_tracker_init
    restart: "no"  # Ð—Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð¾Ð´Ð¸Ð½ Ñ€Ð°Ð· Ð¸ Ð²Ñ‹ÐºÐ»ÑŽÑ‡Ð¸Ñ‚ÑŒ
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://user:passd@db:5432/reels
      # Instagram Auth (Ð½ÑƒÐ¶Ð½Ð¾ Ð´Ð»Ñ init_accounts)
      - INSTAGRAM_SESSIONID=80323489287%3AxvPdwvGMkRUTLi%3A3%3AAYhPEoUwml7Hl61PGx2X33znEOIHjUtAJ9qEAOfLLQ
      - INSTAGRAM_CSRFTOKEN=v5x4RvhJszAmAjdTMITIY5IaXp5yWnAH
      # ÐŸÑƒÑ‚ÑŒ Ðº JSON Ñ Ð°ÐºÐºÐ°ÑƒÐ½Ñ‚Ð°Ð¼Ð¸
      - ACCOUNTS_JSON=/app/scripts/usernames.json
    volumes:
      - ./scripts:/app/scripts
      - ./alembic:/app/alembic
      - ./alembic.ini:/app/alembic.ini
    networks:
      - instagram_tracker_network
    depends_on:
      db:
        condition: service_healthy
    command: >
      bash -c "
        echo 'âœ… Database is ready!' &&
        echo 'ðŸ”„ Running database migrations...' &&
        alembic upgrade head &&
        echo 'âœ… Migrations complete!' &&
        echo 'ðŸ“¥ Initializing accounts from JSON...' &&
        python scripts/init_accounts.py /app/scripts/usernames.json &&
        echo 'âœ… Initialization complete!'
      "

  # Admin Panel
  admin:
    build:
      context: .
      dockerfile: Dockerfile.admin
    container_name: instagram_tracker_admin
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://user:passd@db:5432/reels
    volumes:
      - ./audio:/app/audio
      - ./logs:/app/logs
    networks:
      - instagram_tracker_network
    depends_on:
      init:
        condition: service_completed_successfully
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/dashboard"]
      interval: 30s
      timeout: 10s
      retries: 3

  # Worker
  worker:
    build:
      context: .
      dockerfile: Dockerfile.worker
    container_name: instagram_tracker_worker
    restart: unless-stopped
    environment:
      # Database
      - DATABASE_URL=postgresql+asyncpg://user:passd@db:5432/reels
      # Instagram Auth
      - INSTAGRAM_SESSIONID=80323489287%3AxvPdwvGMkRUTLi%3A3%3AAYhPEoUwml7Hl61PGx2X33znEOIHjUtAJ9qEAOfLLQ
      - INSTAGRAM_CSRFTOKEN=v5x4RvhJszAmAjdTMITIY5IaXp5yWnAH
      # Worker settings
      - WORKER_INTERVAL_HOURS=24
      - WORKER_REELS_LIMIT=50
      - AUDIO_DIR=audio
      - TEST_MODE=false
    volumes:
      - ./audio:/app/audio
      - ./logs:/app/logs
      - ./cookies:/app/cookies
    networks:
      - instagram_tracker_network
    depends_on:
      init:
        condition: service_completed_successfully

networks:
  instagram_tracker_network:
    driver: bridge

volumes:
  postgres_data:
