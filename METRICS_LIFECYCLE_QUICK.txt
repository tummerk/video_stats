╔════════════════════════════════════════════════════════════════════╗
║                 КАК СОЗДАЮТСЯ МЕТРИКИ - КРАТКО                   ║
╚════════════════════════════════════════════════════════════════════╝

┌─ ПОЛНЫЙ ЦИКЛ ─────────────────────────────────────────────────────┐
│                                                                    │
│  1. ПОЛУЧЕНИЕ ВИДЕО  ─────► 2. РАСПИСАНИЕ  ─────► 3. ВЫПОЛНЕНИЕ │
│     (каждые 6 ч)          (сразу)            (каждую минуту)      │
│                                                  │                 │
│                                                  ▼                 │
│                                            4. СБОР МЕТРИК         │
│                                                  │                 │
│                                                  ▼                 │
│                                            5. СЛЕДУЮЩЕЕ           │
│                                               РАСПИСАНИЕ           │
│                                                  │                 │
│                                                  └────────► цикл    │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ШАГ 1: ПОЛУЧЕНИЕ ВИДЕО ──────────────────────────────────────────┐
│                                                                    │
│  Когда: Каждые 6 часов (обычный) / 10 секунд (тест)               │
│  Задача: fetch_new_videos()                                       │
│                                                                    │
│  Процесс:                                                          │
│    1. Получить все аккаунты из БД                                 │
│    2. Для каждого аккаунта:                                       │
│       - Вызвать Instagram API                                     │
│       - Получить reels (до 50 штук)                               │
│       - Для каждого reel:                                         │
│         • Скачать аудио (yt-dlp)                                  │
│         • Транскрибировать (Whisper)                              │
│         • Сохранить в БД (таблица videos)                         │
│                                                                    │
│  Результат:                                                        │
│    ✅ Записи в accounts, videos                                   │
│    ✅ Файлы audio/{shortcode}.mp3                                  │
│    ❌ Ещё нет расписаний и метрик                                 │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ШАГ 2: СОЗДАНИЕ РАСПИСАНИЯ ───────────────────────────────────────┐
│                                                                    │
│  Когда:                                                            │
│    • Сразу после получения видео                                   │
│    • Отдельная задача: каждый час                                 │
│                                                                    │
│  Задача: update_metric_schedules()                                │
│                                                                    │
│  Процесс:                                                          │
│    1. Найти видео БЕЗ расписаний                                  │
│    2. Для каждого видео:                                          │
│       - Вычислить возраст (video_age = now - published_at)       │
│       - Определить интервал:                                      │
│         • 0-1 час    → каждые 1 час                               │
│         • 1-7 часов  → каждые 2 часа                              │
│         • 7-31 часов → каждые 12 часов                            │
│         • 2+ дней    → каждый день                                │
│       - Создать расписание:                                       │
│         scheduled_at = now + interval                             │
│         status = "pending"                                        │
│                                                                    │
│  Результат:                                                        │
│    ✅ Запись в metric_schedules:                                  │
│       video_id, schedule_type, scheduled_at, status="pending"     │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ШАГ 3: ВЫПОЛНЕНИЕ РАСПИСАНИЯ ────────────────────────────────────┐
│                                                                    │
│  Когда: Каждую минуту (обычный) / 10 секунд (тест)                │
│  Задача: process_scheduled_metrics()                             │
│                                                                    │
│  Процесс:                                                          │
│    1. Найти "просроченные" расписания:                            │
│       WHERE status = 'pending' AND scheduled_at <= NOW()          │
│    2. Для каждого расписания:                                     │
│       - Перейти к Шагу 4 (сбор метрик)                           │
│                                                                    │
│  Результат:                                                        │
│    ✅ Найдены расписания, которые нужно выполнить                  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ШАГ 4: СБОР МЕТРИК ──────────────────────────────────────────────┐
│                                                                    │
│  Когда: Внутри process_scheduled_metrics()                        │
│  Задача: fetch_metrics_public()                                   │
│                                                                    │
│  Процесс:                                                          │
│    1. Вызвать Instagram API                                       │
│    2. Получить метрики видео:                                     │
│       • view_count                                                │
│       • like_count                                                │
│       • comment_count                                             │
│       • followers_count                                           │
│    3. Сохранить в БД (таблица metrics)                            │
│    4. Отметить расписание как completed                           │
│                                                                    │
│  Результат:                                                        │
│    ✅ Запись в metrics:                                           │
│       video_id, view_count, like_count, comment_count,            │
│       followers_count, recorded_at                                │
│    ✅ Обновление metric_schedules: status='completed'             │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ШАГ 5: СЛЕДУЮЩЕЕ РАСПИСАНИЕ ────────────────────────────────────┐
│                                                                    │
│  Когда: Сразу после Шага 4                                        │
│  Задача: create_schedule_for_video()                             │
│                                                                    │
│  Процесс:                                                          │
│    1. Вычислить новый возраст видео                               │
│    2. Определить НОВЫЙ интервал (возможно, другой)                │
│    3. Создать СЛЕДУЮЩЕЕ расписание                                │
│                                                                    │
│  Результат:                                                        │
│    ✅ Новая запись в metric_schedules                             │
│    🔄 Цикл повторяется с Шага 3                                   │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ПРИМЕР: НОВОЕ ВИДЕО ────────────────────────────────────────────┐
│                                                                    │
│  10:00 - Видео опубликовано в Instagram                           │
│                                                                    │
│  10:05 - Шаг 1: Получение видео                                   │
│          ✅ Сохранено в БД                                         │
│                                                                    │
│  10:06 - Шаг 2: Создание расписания                              │
│          ✅ scheduled_at = 11:06 (через 1 час)                    │
│          ✅ status = "pending"                                    │
│                                                                    │
│  11:06 - Шаг 3: Выполнение расписания                            │
│          ✅ Найдено расписание (scheduled_at <= NOW)              │
│                                                                    │
│       - Шаг 4: Сбор метрик                                       │
│          ✅ view_count = 1000                                     │
│          ✅ like_count = 50                                       │
│          ✅ comment_count = 10                                    │
│          ✅ Сохранено в metrics                                   │
│          ✅ Расписание отмечено как completed                     │
│                                                                    │
│  11:07 - Шаг 5: Следующее расписание                             │
│          ✅ scheduled_at = 13:07 (через 2 часа)                   │
│          ✅ status = "pending"                                    │
│                                                                    │
│  13:07 - Цикл повторяется...                                     │
│          ✅ Сбор метрик (view_count выросло!)                     │
│          ✅ Создание расписания на 15:07                          │
│                                                                    │
│  15:07 - Цикл повторяется...                                     │
│          ✅ Создание расписания на 03:07 (следующий день)         │
│                                                                    │
│  ...и так далее, каждый день                                      │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ТАБЛИЦА БАЗЫ ДАННЫХ ─────────────────────────────────────────────┐
│                                                                    │
│  ┌─────────────┐     ┌──────────────────┐     ┌──────────────┐  │
│  │   videos    │────┤ metric_schedules │────┤   metrics     │  │
│  └─────────────┘     └──────────────────┘     └──────────────┘  │
│                                                                    │
│  videos:                                                           │
│    id, shortcode, account_id, published_at, ...                   │
│                                                                    │
│  metric_schedules:                                                │
│    id, video_id, scheduled_at, status, completed_at               │
│    (status = pending → completed)                                 │
│                                                                    │
│  metrics:                                                          │
│    id, video_id, view_count, like_count, comment_count,           │
│    followers_count, recorded_at                                   │
│                                                                    │
│  Отношения:                                                        │
│    1 video →_MANY metric_schedules                                │
│    1 video →_MANY metrics                                         │
│    1 schedule →1 metric (когда выполняется)                       │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ КЛЮЧЕВЫЕ МОМЕНТЫ ───────────────────────────────────────────────┐
│                                                                    │
│  ✅ Одно видео = МНОГО метрик                                     │
│     Не одна метрика, а множество snapshot'ов во времени!         │
│                                                                    │
│  ✅ Расписание ≠ Метрики                                          │
│     metric_schedules - когда СНИМАТЬ                             │
│     metrics - САМИ метрики                                       │
│                                                                    │
│  ✅ Цикличность                                                   │
│     После сбора метрик → создаётся НОВОЕ расписание              │
│     Интервал увеличивается по мере взросления видео               │
│                                                                    │
│  ❌ Неправильно: "Метрики снимаются сразу при получении видео"    │
│  ✅ Правильно: "Метрики снимаются ПО РАСПИСАНИЮ"                  │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ИНТЕРВАЛЫ СБОРА МЕТРИК ─────────────────────────────────────────┐
│                                                                    │
│  Возраст видео      Интервал               Пример                 │
│  ────────────────── ─────────────────────  ────────────────────  │
│  0 - 1 час         Каждые 1 час          15:00, 16:00, 17:00     │
│  1 - 7 часов       Каждые 2 часа         15:00, 17:00, 19:00     │
│  7 - 31 часов      Каждые 12 часов       15:00, 03:00, 15:00     │
│  2+ дней           Каждый день            15:00, 15:00, 15:00     │
│                                                                    │
│  Логика:                                                             │
│    • Свежее видео → чаще (быстро растёт)                         │
│    • Старое видео → реже (медленнее растёт)                      │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

┌─ ЗАДАЧИ WORKER ───────────────────────────────────────────────────┐
│                                                                    │
│  Задача 1: fetch_new_videos                                       │
│    • Интервал: 6 часов (обычный) / 10 сек (тест)                 │
│    • Что делает: Получает reels из Instagram                     │
│    • Создаёт: записи в videos                                    │
│                                                                    │
│  Задача 2: update_metric_schedules                                │
│    • Интервал: 1 час (обычный) / 30 сек (тест)                   │
│    • Что делает: Создаёт расписания для видео                    │
│    • Создаёт: записи в metric_schedules (pending)                │
│                                                                    │
│  Задача 3: process_scheduled_metrics                             │
│    • Интервал: 1 минута (обычный) / 10 сек (тест)                │
│    • Что делает: Выполняет расписания                             │
│    • Создаёт: записи в metrics, обновляет schedules              │
│                                                                    │
└────────────────────────────────────────────────────────────────────┘

╔════════════════════════════════════════════════════════════════════╗
║  Подробная документация: METRICS_LIFECYCLE.md                    ║
╚════════════════════════════════════════════════════════════════════╝
