# =============================================================================
# Instagram Reels Tracker - Worker Dockerfile
# =============================================================================
FROM python:3.12-slim

# Set working directory
WORKDIR /app

# Install system dependencies
# - ffmpeg: required for yt-dlp and audio processing
# - gcc: required for building some Python packages
RUN apt-get update && apt-get install -y \
    ffmpeg \
    gcc \
    && rm -rf /var/lib/apt/lists/*

# =============================================================================
# PROXY SUPPORT
# =============================================================================
# Install PySocks for SOCKS proxy support (required by instagrapi)
# This enables HTTP, HTTPS, and SOCKS proxy support
RUN pip install --no-cache-dir PySocks

# =============================================================================
# STEP 1: Install CPU-only PyTorch FIRST
# =============================================================================
# This is CRITICAL - PyTorch CPU must be installed before whisper
# to avoid pulling in CUDA/GPU dependencies
RUN pip install --no-cache-dir \
    torch \
    --index-url https://download.pytorch.org/whl/cpu

# =============================================================================
# STEP 2: Install remaining Python dependencies
# =============================================================================
# Copy requirements file
COPY requirements.worker.txt .

# Install all dependencies from requirements.worker.txt
# PyTorch is already installed, so openai-whisper will use the CPU version
RUN pip install --no-cache-dir -r requirements.worker.txt

# =============================================================================
# STEP 3: Copy application code
# =============================================================================
# Copy source code (models, repositories, services, config, database)
COPY src/ ./src/

# Copy unified worker script
COPY unified_worker.py .

# Copy admin services (needed for WorkerMonitor/heartbeat)
COPY admin/services/ ./admin/services/

# Copy database migrations
COPY alembic/ ./alembic/
COPY alembic.ini .

# Create necessary directories
RUN mkdir -p logs audio

# =============================================================================
# STEP 4: Set environment variables
# =============================================================================
# Default to production mode (override with TEST_MODE=true in .env if needed)
ENV TEST_MODE=false

# =============================================================================
# STEP 5: Health check
# =============================================================================
# Check if worker process is running
HEALTHCHECK --interval=30s --timeout=10s --start-period=5s --retries=3 \
    CMD pgrep -f "python.*unified_worker.py" || exit 1

# =============================================================================
# STEP 6: Run the worker
# =============================================================================
CMD ["python", "unified_worker.py"]
