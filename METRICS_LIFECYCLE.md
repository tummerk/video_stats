# –ñ–∏–∑–Ω–µ–Ω–Ω—ã–π —Ü–∏–∫–ª –º–µ—Ç—Ä–∏–∫ - –ü–æ–ª–Ω–æ–µ –æ–±—ä—è—Å–Ω–µ–Ω–∏–µ

## üìã –û–≥–ª–∞–≤–ª–µ–Ω–∏–µ
1. [–û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞](#–æ–±–∑–æ—Ä-–ø—Ä–æ—Ü–µ—Å—Å–∞)
2. [–®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ](#—à–∞–≥-1-–ø–æ–ª—É—á–µ–Ω–∏–µ-–≤–∏–¥–µ–æ)
3. [–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π](#—à–∞–≥-2-—Å–æ–∑–¥–∞–Ω–∏–µ-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π)
4. [–®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π](#—à–∞–≥-3-–≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π)
5. [–®–∞–≥ 4: –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫](#—à–∞–≥-4-—Å–±–æ—Ä-–º–µ—Ç—Ä–∏–∫)
6. [–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è](#–∏–Ω—Ç–µ—Ä–≤–∞–ª—ã-—Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è)
7. [–ü—Ä–∏–º–µ—Ä —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏](#–ø—Ä–∏–º–µ—Ä-—Å-—Ä–µ–∞–ª—å–Ω—ã–º–∏-–¥–∞–Ω–Ω—ã–º–∏)

---

## –û–±–∑–æ—Ä –ø—Ä–æ—Ü–µ—Å—Å–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                     –ñ–ò–ó–ù–ï–ù–ù–´–ô –¶–ò–ö–õ –í–ò–î–ï–û                           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

1. –ü–û–õ–£–ß–ï–ù–ò–ï –í–ò–î–ï–û (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
   ‚îú‚îÄ –ü–æ–ª—É—á–µ–Ω–∏–µ reels –∏–∑ Instagram
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
   ‚îî‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –ü–ï–†–í–û–ì–û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–ô (–∫–∞–∂–¥—ã–π —á–∞—Å)
   ‚îî‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π –¥–ª—è –Ω–æ–≤—ã—Ö –≤–∏–¥–µ–æ

3. –í–´–ü–û–õ–ù–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–ô (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)
   ‚îú‚îÄ –ü—Ä–æ–≤–µ—Ä–∫–∞ pending —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
   ‚îú‚îÄ –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫ –∏–∑ Instagram
   ‚îú‚îÄ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î
   ‚îî‚îÄ –°–æ–∑–¥–∞–Ω–∏–µ –°–õ–ï–î–£–Æ–©–ï–ì–û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
```

---

## –®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ

### –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- **–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º**: –ö–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
- **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**: –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç

**–ó–∞–¥–∞—á–∞**: `fetch_new_videos()` –≤ `unified_worker.py`

```python
async def fetch_new_videos(self):
    """Fetch new reels from all accounts (every 6 hours)."""
```

### –ü—Ä–æ—Ü–µ—Å—Å

#### 1.1 –ü–æ–ª—É—á–∞–µ—Ç –≤—Å–µ –∞–∫–∫–∞—É–Ω—Ç—ã –∏–∑ –ë–î
```python
accounts = await account_repo.get_all()
# => [account1, account2, ...]
```

#### 1.2 –î–ª—è –∫–∞–∂–¥–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞:
```python
for account in accounts:
    # –í—ã–∑—ã–≤–∞–µ—Ç InstagramService
    await self.instagram_service.get_user_recent_videos(
        user_pk=account.id,      # Instagram ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
        username=account.username,
        limit=settings.worker_reels_limit  # –ú–∞–∫—Å–∏–º—É–º 50 –≤–∏–¥–µ–æ
    )
```

#### 1.3 InstagramService: `get_user_recent_videos()`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç –≤ InstagramService** (`src/services/instagram_service.py:290-376`):

```python
async def get_user_recent_videos(self, user_pk: int, username: str = None, limit: int = 50):
```

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç –Ω–∞–ª–∏—á–∏–µ –∞–∫–∫–∞—É–Ω—Ç–∞ –≤ –ë–î**
   ```python
   account = await account_repo.get_by_id(user_pk)
   ```

2. **–ï—Å–ª–∏ –∞–∫–∫–∞—É–Ω—Ç–∞ –Ω–µ—Ç - —Å–æ–∑–¥–∞—ë—Ç**
   ```python
   account = await account_repo.create(
       id=user_pk,
       username=username,
       profile_url=f"https://www.instagram.com/{username}/",
       followers_count=None
   )
   ```

3. **–ü–æ–ª—É—á–∞–µ—Ç reels –∏–∑ Instagram**
   ```python
   # –í—ã–∑—ã–≤–∞–µ—Ç instagrapi
   clips = client.user_clips_v1(user_pk, amount=limit)
   # => —Å–ø–∏—Å–æ–∫ reels –∏–∑ Instagram
   ```

4. **–î–ª—è –∫–∞–∂–¥–æ–≥–æ reel:**
   ```python
   for clip in clips:
       shortcode = clip.code  # –ù–∞–ø—Ä–∏–º–µ—Ä: "CzX8kKqRdXY"
       published_at = datetime.fromtimestamp(clip.taken_at)

       # –ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ, —Å–∫–∞—á–∏–≤–∞–µ—Ç –∞—É–¥–∏–æ, —Ç—Ä–∞–Ω—Å–∫—Ä–∏–±–∏—Ä—É–µ—Ç
       video_data = await self._extract_reel_with_audio(reel_url, shortcode)

       # –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
       await video_repo.create_or_update_by_shortcode(
           shortcode=shortcode,
           account_id=account.id,
           video_id=video_data.get('id'),           # media_pk
           video_url=video_data.get('webpage_url'),
           published_at=published_at,
           caption=video_data.get('description'),
           duration_seconds=int(video_data.get('duration', 0)),
           audio_file_path=video_data.get('audio_file_path'),
           transcription=video_data.get('transcription'),
       )
   ```

### –†–µ–∑—É–ª—å—Ç–∞—Ç —à–∞–≥–∞ 1

‚úÖ **–í –ë–î —Å–æ–∑–¥–∞–Ω—ã –∑–∞–ø–∏—Å–∏:**
- –¢–∞–±–ª–∏—Ü–∞ `accounts`: –∞–∫–∫–∞—É–Ω—Ç Instagram
- –¢–∞–±–ª–∏—Ü–∞ `videos`: –≤–∏–¥–µ–æ reels —Å –º–µ—Ç–∞–¥–∞–Ω–Ω—ã–º–∏
- –ê—É–¥–∏–æ —Ñ–∞–π–ª: `audio/{shortcode}.mp3`
- –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è: —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞ –≤ `video.transcription`

‚ùå **–ï—â—ë –ù–ï–¢:**
- –ó–∞–ø–∏—Å–µ–π –≤ `metric_schedules` (—Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ —à–∞–≥–µ 2)
- –ó–∞–ø–∏—Å–µ–π –≤ `metrics` (—Å–æ–∑–¥–∞—é—Ç—Å—è –Ω–∞ —à–∞–≥–µ 4)

---

## –®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π

### –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- **–°—Ä–∞–∑—É –ø–æ—Å–ª–µ** –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ (–≤ `fetch_new_videos()`)
- **–û—Ç–¥–µ–ª—å–Ω–∞—è –∑–∞–¥–∞—á–∞**: –ö–∞–∂–¥—ã–π —á–∞—Å (–æ–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º) / 30 —Å–µ–∫—É–Ω–¥ (—Ç–µ—Å—Ç–æ–≤—ã–π)

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç

**–ó–∞–¥–∞—á–∞**: `update_metric_schedules()` –≤ `unified_worker.py`

```python
async def update_metric_schedules(self):
    """Create/update metric schedules for videos (every 1 hour)."""
```

### –ü—Ä–æ—Ü–µ—Å—Å

#### 2.1 –ü–æ–ª—É—á–∞–µ—Ç –≤–∏–¥–µ–æ –±–µ–∑ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π
```python
videos = await video_repo.get_videos_for_schedule_update(limit=100)
# => –≤–∏–¥–µ–æ, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –ù–ï–¢ –∑–∞–ø–∏—Å–µ–π –≤ metric_schedules
```

**SQL –∑–∞–ø—Ä–æ—Å** (–≤ `video_repository.py:138-157`):
```sql
SELECT * FROM videos
WHERE NOT EXISTS (
    SELECT 1 FROM metric_schedules
    WHERE metric_schedules.video_id = videos.id
)
ORDER BY published_at DESC
LIMIT 100
```

#### 2.2 –î–ª—è –∫–∞–∂–¥–æ–≥–æ –≤–∏–¥–µ–æ —Å–æ–∑–¥–∞—ë—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
```python
for video in videos:
    await self.metrics_scheduler.create_schedule_for_video(video, schedule_repo)
```

#### 2.3 MetricsScheduler: `create_schedule_for_video()`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç** (`unified_worker.py:45-91`):

```python
async def create_schedule_for_video(self, video, schedule_repo):
```

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–í—ã—á–∏—Å–ª—è–µ—Ç –≤–æ–∑—Ä–∞—Å—Ç –≤–∏–¥–µ–æ**
   ```python
   now = datetime.now(timezone.utc)
   published_at = video.published_at.replace(tzinfo=timezone.utc)
   video_age = now - published_at
   # –ù–∞–ø—Ä–∏–º–µ—Ä: timedelta(days=2, hours=5)
   ```

2. **–û–ø—Ä–µ–¥–µ–ª—è–µ—Ç –∏–Ω—Ç–µ—Ä–≤–∞–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ –≤–æ–∑—Ä–∞—Å—Ç–∞**

   ```python
   # –§–∞–∑—ã:
   # Phase 1: 0-1 —á–∞—Å    ‚Üí –∫–∞–∂–¥—ã–µ 1 —á–∞—Å
   # Phase 2: 1-7 —á–∞—Å–æ–≤  ‚Üí –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
   # Phase 3: 7-31 —á–∞—Å–æ–≤ ‚Üí –∫–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤
   # Phase 4: 2+ –¥–Ω–µ–π    ‚Üí –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

   if video_age <= 1 hour:
       target_interval = {"hours": 1}
   elif video_age <= 7 hours:
       target_interval = {"hours": 2}
   elif video_age <= 31 hours:
       target_interval = {"hours": 12}
   else:
       target_interval = {"days": 1}
   ```

3. **–ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —É–∂–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ**
   ```python
   existing_schedules = await schedule_repo.get_pending_schedules_by_video(video.id)
   if existing_schedules:
       return  # –ù–µ —Å–æ–∑–¥–∞—ë–º, –µ—Å–ª–∏ —É–∂–µ –µ—Å—Ç—å pending
   ```

4. **–°–æ–∑–¥–∞—ë—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ**
   ```python
   scheduled_at = now + timedelta(**target_interval)

   await schedule_repo.create_schedule(
       video_id=video.id,
       schedule_type="metrics",
       scheduled_at=scheduled_at,
       status="pending"
   )
   ```

### –†–µ–∑—É–ª—å—Ç–∞—Ç —à–∞–≥–∞ 2

‚úÖ **–í –ë–î —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –≤ `metric_schedules`:**
```sql
INSERT INTO metric_schedules (
    video_id,
    schedule_type,
    scheduled_at,
    status,
    created_at
) VALUES (
    123,                    -- video.id
    'metrics',
    '2025-02-05 15:30:00', -- now + interval
    'pending',
    '2025-02-05 14:30:00'
)
```

---

## –®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π

### –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- **–û–±—ã—á–Ω—ã–π —Ä–µ–∂–∏–º**: –ö–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
- **–¢–µ—Å—Ç–æ–≤—ã–π —Ä–µ–∂–∏–º**: –ö–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç

**–ó–∞–¥–∞—á–∞**: `process_scheduled_metrics()` –≤ `unified_worker.py`

```python
async def process_scheduled_metrics(self):
    """Execute pending scheduled tasks (every 1 minute)."""
```

### –ü—Ä–æ—Ü–µ—Å—Å

#### 3.1 –ü–æ–ª—É—á–∞–µ—Ç "–ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ" —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
```python
pending = await schedule_repo.get_pending_schedules()
```

**SQL –∑–∞–ø—Ä–æ—Å** (–≤ `metric_schedule_repository.py:31-55`):
```sql
SELECT * FROM metric_schedules
WHERE status = 'pending'
  AND scheduled_at <= NOW()
ORDER BY scheduled_at
```

**–ü—Ä–∏–º–µ—Ä:**
```python
# –°–µ–π—á–∞—Å: 2025-02-05 15:35:00
# –ü–æ–ª—É—á–∏—Ç —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å scheduled_at <= 2025-02-05 15:35:00
```

#### 3.2 –î–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è:
```python
for schedule in pending:
    video = schedule.video
    logger.info(f"Processing {schedule.schedule_type} for {video.shortcode}")

    # –®–∞–≥ 4: –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫
    metrics_data = await self.fetch_metrics_public(video.video_id)

    # –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –º–µ—Ç—Ä–∏–∫
    await metrics_repo.create_metrics_snapshot(...)

    # –û—Ç–º–µ—Ç–∫–∞ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–≥–æ
    await schedule_repo.mark_completed(schedule.id)

    # –°–æ–∑–¥–∞–Ω–∏–µ –°–õ–ï–î–£–Æ–©–ï–ì–û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è
    await self.metrics_scheduler.create_schedule_for_video(video, schedule_repo)
```

---

## –®–∞–≥ 4: –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫

### –ö–æ–≥–¥–∞ –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è
- **–í–Ω—É—Ç—Ä–∏** `process_scheduled_metrics()` –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

### –ß—Ç–æ –¥–µ–ª–∞–µ—Ç

**–ú–µ—Ç–æ–¥**: `fetch_metrics_public()` –≤ `unified_worker.py`

```python
async def fetch_metrics_public(self, video_id: str) -> dict:
    """Fetch metrics using InstagramService."""
```

### –ü—Ä–æ—Ü–µ—Å—Å

#### 4.1 –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç video_id –≤ media_pk
```python
# video.video_id - —ç—Ç–æ —Å—Ç—Ä–æ–∫–∞ "123456789"
# –ù—É–∂–Ω–æ –ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –≤ int –¥–ª—è Instagram API
media_pk = int(video_id)
```

#### 4.2 –í—ã–∑—ã–≤–∞–µ—Ç InstagramService
```python
metrics = await self.instagram_service.get_video_metrics(media_pk)
```

#### 4.3 InstagramService: `get_video_metrics()`

**–ß—Ç–æ –¥–µ–ª–∞–µ—Ç** (–≤ `src/services/instagram_service.py`):

```python
async def get_video_metrics(self, media_pk: int) -> VideoMetrics:
```

**–ü—Ä–æ—Ü–µ—Å—Å:**

1. **–ü–æ–ª—É—á–∞–µ—Ç –º–µ–¥–∏–∞ –∏–∑ Instagram**
   ```python
   def _fetch_media_info(client):
       return client.media_info(media_pk)

   media = await self._execute_instagram_request(_fetch_media_info)
   ```

2. **–ò–∑–≤–ª–µ–∫–∞–µ—Ç –º–µ—Ç—Ä–∏–∫–∏**
   ```python
   from src.services.models import VideoMetrics

   return VideoMetrics(
       view_count=media.view_count,
       like_count=media.like_count,
       comment_count=media.comment_count,
       followers_count=None  # –ù—É–∂–Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ–µ –ø–æ–ª—É—á–µ–Ω–∏–µ
   )
   ```

3. **–î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª—É—á–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –ø–æ–¥–ø–∏—Å—á–∏–∫–æ–≤**
   ```python
   # –ü–æ–ª—É—á–∞–µ—Ç –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≤–ª–∞–¥–µ–ª—å—Ü–µ –≤–∏–¥–µ–æ
   user_info = await self._execute_instagram_request(
       lambda client: client.user_info(media.user.pk)
   )

   metrics.followers_count = user_info.follower_count
   ```

#### 4.4 –°–æ—Ö—Ä–∞–Ω—è–µ—Ç –≤ –ë–î
```python
await metrics_repo.create_metrics_snapshot(
    video_id=video.id,
    view_count=metrics_data['view_count'] or 0,
    like_count=metrics_data['like_count'],
    comment_count=metrics_data['comment_count'],
    followers_count=metrics_data['followers_count'] or 0
)
```

**SQL –∑–∞–ø—Ä–æ—Å** (–≤ `metrics_repository.py`):
```sql
INSERT INTO metrics (
    video_id,
    view_count,
    like_count,
    comment_count,
    followers_count,
    recorded_at
) VALUES (
    123,
    5432,
    123,
    45,
    9876,
    NOW()
)
```

### –†–µ–∑—É–ª—å—Ç–∞—Ç —à–∞–≥–∞ 4

‚úÖ **–í –ë–î —Å–æ–∑–¥–∞–Ω–∞ –∑–∞–ø–∏—Å—å –≤ `metrics`:**
```sql
id          | video_id | view_count | like_count | comment_count | followers_count | recorded_at
------------|----------|------------|------------|---------------|-----------------|---------------------
1           | 123      | 5432       | 123        | 45            | 9876            | 2025-02-05 15:35:00
```

‚úÖ **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –æ—Ç–º–µ—á–µ–Ω–æ –∫–∞–∫ –≤—ã–ø–æ–ª–Ω–µ–Ω–Ω–æ–µ:**
```sql
UPDATE metric_schedules
SET status = 'completed',
    completed_at = NOW()
WHERE id = 456
```

‚úÖ **–°–æ–∑–¥–∞–Ω–æ –°–õ–ï–î–£–Æ–©–ï–ï —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ** (–≤–æ–∑–≤—Ä–∞—â–∞—è—Å—å –∫ —à–∞–≥—É 2)

---

## –ò–Ω—Ç–µ—Ä–≤–∞–ª—ã —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è

### –¢–∞–±–ª–∏—Ü–∞ –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–≤

| –í–æ–∑—Ä–∞—Å—Ç –≤–∏–¥–µ–æ      | –ò–Ω—Ç–µ—Ä–≤–∞–ª —Å–±–æ—Ä–∞ –º–µ—Ç—Ä–∏–∫ | –ü—Ä–∏–º–µ—Ä                    |
|--------------------|----------------------|---------------------------|
| 0 - 1 —á–∞—Å         | –ö–∞–∂–¥—ã–µ 1 —á–∞—Å         | 15:00, 16:00, 17:00...    |
| 1 - 7 —á–∞—Å–æ–≤       | –ö–∞–∂–¥—ã–µ 2 —á–∞—Å–∞        | 15:00, 17:00, 19:00...    |
| 7 - 31 —á–∞—Å–æ–≤      | –ö–∞–∂–¥—ã–µ 12 —á–∞—Å–æ–≤      | 15:00, 03:00, 15:00...    |
| 2+ –¥–Ω–µ–π           | –ö–∞–∂–¥—ã–π –¥–µ–Ω—å          | 15:00, 15:00, 15:00...    |

### –ö–æ–¥ –∏–∑ `unified_worker.py`

```python
class MetricsScheduler:
    # Schedule intervals based on video age
    SCHEDULE_INTERVALS = [
        {"hours": 1},    # First hour: every hour
        {"hours": 2},    # Next 6 hours: every 2 hours
        {"hours": 12},   # Next 2 days: every 12 hours
        {"days": 1},     # After that: daily
    ]

    # Total duration for each phase
    PHASE_DURATIONS = [
        timedelta(hours=1),    # Phase 1: 1 hour
        timedelta(hours=6),    # Phase 2: 6 hours
        timedelta(days=2),     # Phase 3: 2 days
    ]
```

### –ö–∞–∫ –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –∏–Ω—Ç–µ—Ä–≤–∞–ª

```python
# –ü—Ä–∏–º–µ—Ä: –≤–∏–¥–µ–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ 5 —á–∞—Å–æ–≤ –Ω–∞–∑–∞–¥

video_age = timedelta(hours=5)

# –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–∞–∑:
# Phase 1: 0-1 —á–∞—Å    ‚Üí 5 > 1  ‚úó
# Phase 2: 1-7 —á–∞—Å–æ–≤  ‚Üí 1 < 5 < 7  ‚úì

# –ò–Ω—Ç–µ—Ä–≤–∞–ª: –∫–∞–∂–¥—ã–µ 2 —á–∞—Å–∞
target_interval = {"hours": 2}
scheduled_at = now + timedelta(hours=2)
```

---

## –ü—Ä–∏–º–µ—Ä —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π: –ù–æ–≤–æ–µ –≤–∏–¥–µ–æ –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ

#### **–í—Ä–µ–º—è: 2025-02-05 10:00:00**

**–®–∞–≥ 1: –ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ** (—á–µ—Ä–µ–∑ 6 —á–∞—Å–æ–≤ –ø–æ—Å–ª–µ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –ø–æ–ª—É—á–µ–Ω–∏—è)

```bash
Starting fetch_new_videos task (Run #1)
Found 1 accounts in database
Processing account: username (id=12345)
Fetched 5 reels from Instagram
Saved video CzX8kKqRdXY to database (with audio and transcription)
```

**–ë–î:**
```sql
-- videos
id  | shortcode       | account_id | published_at
-----|-----------------|------------|---------------------
1    | CzX8kKqRdXY     | 12345      | 2025-02-05 09:55:00
```

---

#### **–í—Ä–µ–º—è: 2025-02-05 10:00:05**

**–®–∞–≥ 2: –°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è** (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –≤–∏–¥–µ–æ)

```bash
Checking for videos needing schedule updates...
Found 1 videos needing schedules
Created schedule for CzX8kKqRdXY (age: 0d) at 2025-02-05 11:00:00 (interval: {'hours': 1})
```

**–ë–î:**
```sql
-- metric_schedules
id  | video_id | schedule_type | scheduled_at       | status
-----|----------|---------------|--------------------|--------
1    | 1        | metrics       | 2025-02-05 11:00:00 | pending
```

---

#### **–í—Ä–µ–º—è: 2025-02-05 11:00:00** (1 —á–∞—Å —Å–ø—É—Å—Ç—è)

**–®–∞–≥ 3: –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è**

```bash
Processing scheduled metrics collection (Run #60)
Found 1 due schedules
Processing metrics for CzX8kKqRdXY
```

**–®–∞–≥ 4: –°–±–æ—Ä –º–µ—Ç—Ä–∏–∫**

```bash
Fetching metrics for video 123456789
View count: 1000
Like count: 50
Comment count: 10
Followers count: 5000
Saved metrics snapshot
```

**–ë–î:**
```sql
-- metrics
id  | video_id | view_count | like_count | comment_count | followers_count | recorded_at
-----|----------|------------|------------|---------------|-----------------|---------------------
1    | 1        | 1000       | 50         | 10            | 5000            | 2025-02-05 11:00:00

-- metric_schedules (–æ–±–Ω–æ–≤–ª–µ–Ω–æ)
id  | video_id | schedule_type | scheduled_at       | status    | completed_at
-----|----------|---------------|--------------------|-----------|---------------------
1    | 1        | metrics       | 2025-02-05 11:00:00 | completed | 2025-02-05 11:00:00
```

---

#### **–í—Ä–µ–º—è: 2025-02-05 11:00:05**

**–°–æ–∑–¥–∞–Ω–∏–µ –°–õ–ï–î–£–Æ–©–ï–ì–û —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è**

```bash
Created schedule for CzX8kKqRdXY (age: 1d) at 2025-02-05 13:00:00 (interval: {'hours': 2})
```

**–ë–î:**
```sql
-- metric_schedules (–Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å)
id  | video_id | schedule_type | scheduled_at       | status
-----|----------|---------------|--------------------|--------
2    | 1        | metrics       | 2025-02-05 13:00:00 | pending
```

---

#### **–í—Ä–µ–º—è: 2025-02-05 13:00:00** (–µ—â—ë 2 —á–∞—Å–∞ —Å–ø—É—Å—Ç—è)

**–ü–æ–≤—Ç–æ—Ä —Ü–∏–∫–ª–∞:**

```bash
Processing metrics for CzX8kKqRdXY
View count: 2500  ‚Üê –≤—ã—Ä–æ—Å–ª–æ!
Like count: 120
Comment count: 25
Followers count: 5050
Saved metrics snapshot

Created schedule for CzX8kKqRdXY (age: 1d) at 2025-02-05 15:00:00 (interval: {'hours': 2})
```

**–ë–î:**
```sql
-- metrics (–Ω–æ–≤–∞—è –∑–∞–ø–∏—Å—å)
id  | video_id | view_count | like_count | comment_count | followers_count | recorded_at
-----|----------|------------|------------|---------------|-----------------|---------------------
1    | 1        | 1000       | 50         | 10            | 5000            | 2025-02-05 11:00:00
2    | 1        | 2500       | 120        | 25            | 5050            | 2025-02-05 13:00:00  <-- –ù–û–í–ê–Ø
```

---

## –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–æ—Ü–µ—Å—Å–∞

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –í–ò–î–ï–û –û–ü–£–ë–õ–ò–ö–û–í–ê–ù–û                                                  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 1: –ü–û–õ–£–ß–ï–ù–ò–ï –í–ò–î–ï–û (—á–µ—Ä–µ–∑ 6 —á–∞—Å–æ–≤)                              ‚îÇ
‚îÇ - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ –ë–î                                                    ‚îÇ
‚îÇ - –°–∫–∞—á–∏–≤–∞–Ω–∏–µ –∞—É–¥–∏–æ                                                  ‚îÇ
‚îÇ - –¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ü–∏—è                                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 2: –°–û–ó–î–ê–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–Ø (—Å—Ä–∞–∑—É –ø–æ—Å–ª–µ)                            ‚îÇ
‚îÇ - –†–∞—Å—á—ë—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –≤–∏–¥–µ–æ                                             ‚îÇ
‚îÇ - –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞                                             ‚îÇ
‚îÇ - –°–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ metric_schedules (status=pending)               ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –û–ñ–ò–î–ê–ù–ò–ï (scheduled_at - now)                                        ‚îÇ
‚îÇ –ü—Ä–∏–º–µ—Ä: 1 —á–∞—Å –¥–ª—è –Ω–æ–≤–æ–≥–æ –≤–∏–¥–µ–æ                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 3: –í–´–ü–û–õ–ù–ï–ù–ò–ï –†–ê–°–ü–ò–°–ê–ù–ò–Ø (–∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É)                        ‚îÇ
‚îÇ - –ü—Ä–æ–≤–µ—Ä–∫–∞: scheduled_at <= NOW()                                   ‚îÇ
‚îÇ - –ü–æ–ª—É—á–µ–Ω–∏–µ pending —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–π                                      ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 4: –°–ë–û–† –ú–ï–¢–†–ò–ö                                                  ‚îÇ
‚îÇ - –ó–∞–ø—Ä–æ—Å –∫ Instagram API                                            ‚îÇ
‚îÇ - –ü–æ–ª—É—á–µ–Ω–∏–µ view/like/comment/followers                             ‚îÇ
‚îÇ - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –≤ metrics                                              ‚îÇ
‚îÇ - –û—Ç–º–µ—Ç–∫–∞ schedule –∫–∞–∫ completed                                    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ –®–∞–≥ 5: –°–õ–ï–î–£–Æ–©–ï–ï –†–ê–°–ü–ò–°–ê–ù–ò–ï                                         ‚îÇ
‚îÇ - –í–æ–∑–≤—Ä–∞—Ç –∫ –®–∞–≥—É 2                                                  ‚îÇ
‚îÇ - –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è —Å –Ω–æ–≤—ã–º –∏–Ω—Ç–µ—Ä–≤–∞–ª–æ–º                     ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                               ‚Üì
                              –¶–ò–ö–õ –ü–û–í–¢–û–†–Ø–ï–¢–°–Ø
```

---

## –ö–ª—é—á–µ–≤—ã–µ –º–æ–º–µ–Ω—Ç—ã

### ‚úÖ –ü—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ

1. **–û–¥–Ω–æ –≤–∏–¥–µ–æ = –ú–ù–û–ì–û –º–µ—Ç—Ä–∏–∫**
   - –ö–∞–∂–¥–æ–µ –≤–∏–¥–µ–æ –ø–æ–ª—É—á–∞–µ—Ç –ù–ï–°–ö–û–õ–¨–ö–û snapshot'–æ–≤ –º–µ—Ç—Ä–∏–∫
   - –ü–µ—Ä–≤—ã–π: —á–µ—Ä–µ–∑ 1 —á–∞—Å –ø–æ—Å–ª–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏
   - –í—Ç–æ—Ä–æ–π: —á–µ—Ä–µ–∑ 2 —á–∞—Å–∞
   - –¢—Ä–µ—Ç–∏–π: —á–µ—Ä–µ–∑ 12 —á–∞—Å–æ–≤
   - –ò —Ç–∞–∫ –¥–∞–ª–µ–µ –∫–∞–∂–¥—ã–π –¥–µ–Ω—å

2. **–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ = –ù–ï –º–µ—Ç—Ä–∏–∫–∏**
   - `metric_schedules` - —ç—Ç–æ –∫–æ–≥–¥–∞ –°–ù–ò–ú–ê–¢–¨ –º–µ—Ç—Ä–∏–∫–∏
   - `metrics` - —ç—Ç–æ –°–ê–ú–ò –º–µ—Ç—Ä–∏–∫–∏ (view, like, comment)
   - –û–¥–Ω–æ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ ‚Üí –æ–¥–∏–Ω snapshot –º–µ—Ç—Ä–∏–∫

3. **–¶–∏–∫–ª–∏—á–Ω–æ—Å—Ç—å**
   - –ü–æ—Å–ª–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è ‚Üí —Å–æ–∑–¥–∞—ë—Ç—Å—è –ù–û–í–û–ï —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ
   - –ò–Ω—Ç–µ—Ä–≤–∞–ª —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è –ø–æ –º–µ—Ä–µ –≤–∑—Ä–æ—Å–ª–µ–Ω–∏—è –≤–∏–¥–µ–æ
   - –í –∏—Ç–æ–≥–µ ‚Üí –µ–∂–µ–¥–Ω–µ–≤–Ω—ã–µ —Å–Ω–∏–º–∫–∏ –º–µ—Ç—Ä–∏–∫

### ‚ùå –û—à–∏–±–æ—á–Ω—ã–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è

1. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**: "–û–¥–Ω–æ –≤–∏–¥–µ–æ = –æ–¥–Ω–∞ –º–µ—Ç—Ä–∏–∫–∞"
   - **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: –û–¥–Ω–æ –≤–∏–¥–µ–æ = –º–Ω–æ–∂–µ—Å—Ç–≤–æ –º–µ—Ç—Ä–∏–∫ –≤–æ –≤—Ä–µ–º–µ–Ω–∏

2. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**: "–†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Å–æ–∑–¥–∞—ë—Ç—Å—è –æ–¥–∏–Ω —Ä–∞–∑"
   - **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: –ü–æ—Å–ª–µ –∫–∞–∂–¥–æ–≥–æ —Å–±–æ—Ä–∞ —Å–æ–∑–¥–∞—ë—Ç—Å—è –ù–û–í–û–ï —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ

3. **–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ**: "–ú–µ—Ç—Ä–∏–∫–∏ —Å–Ω–∏–º–∞—é—Ç—Å—è —Å—Ä–∞–∑—É –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –≤–∏–¥–µ–æ"
   - **–ü—Ä–∞–≤–∏–ª—å–Ω–æ**: –ú–µ—Ç—Ä–∏–∫–∏ —Å–Ω–∏–º–∞—é—Ç—Å—è –ü–û –†–ê–°–ü–ò–°–ê–ù–ò–Æ, –Ω–µ —Å—Ä–∞–∑—É

---

## –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –≤–∏–¥–µ–æ
```sql
SELECT
    id,
    schedule_type,
    scheduled_at,
    status,
    completed_at
FROM metric_schedules
WHERE video_id = 123
ORDER BY scheduled_at;
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ –º–µ—Ç—Ä–∏–∫–∏ –≤–∏–¥–µ–æ
```sql
SELECT
    recorded_at,
    view_count,
    like_count,
    comment_count,
    followers_count
FROM metrics
WHERE video_id = 123
ORDER BY recorded_at;
```

### –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ø—Ä–æ–≥—Ä–µ—Å—Å
```sql
SELECT
    v.shortcode,
    v.published_at,
    COUNT(DISTINCT ms.id) as schedules_count,
    COUNT(DISTINCT m.id) as metrics_count,
    MAX(m.recorded_at) as last_metric_at
FROM videos v
LEFT JOIN metric_schedules ms ON ms.video_id = v.id
LEFT JOIN metrics m ON m.video_id = v.id
GROUP BY v.id
ORDER BY v.published_at DESC;
```

---

## –ò—Ç–æ–≥

**–ú–µ—Ç—Ä–∏–∫–∏ —Å–æ–∑–¥–∞—é—Ç—Å—è –≤ 4 —ç—Ç–∞–ø–∞:**

1. **–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–∏–¥–µ–æ** ‚Üí —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞–ø–∏—Å–∏ –≤ `videos`
2. **–°–æ–∑–¥–∞–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è** ‚Üí –∑–∞–ø–∏—Å—å –≤ `metric_schedules` (status=pending)
3. **–í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è** ‚Üí –∫–æ–≥–¥–∞ `scheduled_at <= NOW()`
4. **–°–±–æ—Ä –º–µ—Ç—Ä–∏–∫** ‚Üí –∑–∞–ø–∏—Å—å –≤ `metrics` + –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ `metric_schedules` (status=completed)
5. **–ü–æ–≤—Ç–æ—Ä** ‚Üí –≤–æ–∑–≤—Ä–∞—Ç –∫ —à–∞–≥—É 2 –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ –∏–Ω—Ç–µ—Ä–≤–∞–ª–∞

**–ò–Ω—Ç–µ—Ä–≤–∞–ª—ã –∑–∞–≤–∏—Å—è—Ç –æ—Ç –≤–æ–∑—Ä–∞—Å—Ç–∞ –≤–∏–¥–µ–æ:**
- –ú–æ–ª–æ–¥–æ–µ –≤–∏–¥–µ–æ (< 1 —á–∞—Å): —á–∞—Å—Ç–æ (–∫–∞–∂–¥—ã–π —á–∞—Å)
- –°—Ä–µ–¥–Ω–µ–µ –≤–∏–¥–µ–æ (1-31 —á–∞—Å): —Ä–µ–∂–µ (–∫–∞–∂–¥—ã–µ 2-12 —á–∞—Å–æ–≤)
- –°—Ç–∞—Ä–æ–µ –≤–∏–¥–µ–æ (> 2 –¥–Ω–µ–π): —Ä–µ–¥–∫–æ (–∫–∞–∂–¥—ã–π –¥–µ–Ω—å)
